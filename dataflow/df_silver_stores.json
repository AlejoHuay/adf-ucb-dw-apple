{
	"name": "df_silver_stores",
	"properties": {
		"folder": {
			"name": "silver"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_sql_stores",
						"type": "DatasetReference"
					},
					"name": "dsStores"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_sql_silver_stores",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "CleanStringsAndCountry"
				},
				{
					"name": "selectColumns"
				},
				{
					"name": "cleanOpenedYear"
				},
				{
					"name": "cleanCity"
				},
				{
					"name": "filtrarBasura"
				},
				{
					"name": "filtrarDuplicados"
				},
				{
					"name": "selectFinal"
				}
			],
			"scriptLines": [
				"source(output(",
				"          store_id as string,",
				"          store_name as string,",
				"          city as string,",
				"          country as string,",
				"          opened_year as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> dsStores",
				"dsStores derive(store_name_clean = trim(replace(replace(store_name, \"'\", \"\"), '\"', \"\")),",
				"          city_clean = upper(trim(city)),",
				"          store_id_clean = upper(trim(store_id)),",
				"          country_clean = iif(isNull(country) || trim(country) == '' || trim(country) == ',', 'UNKNOWN', upper(trim(replace(country, ',', ''))))) ~> CleanStringsAndCountry",
				"cleanCity select(mapColumn(",
				"          store_id = store_id_clean,",
				"          store_name = store_name_clean,",
				"          city = city_clean,",
				"          country = country_clean,",
				"          opened_year = opened_year_clean",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectColumns",
				"CleanStringsAndCountry derive(opened_year_clean = iif(isNull(opened_year) || trim(opened_year) == '', 'UNKNOWN', opened_year)) ~> cleanOpenedYear",
				"cleanOpenedYear derive(city_clean = iif(isNull(city_clean) || trim(city_clean) == '', 'UNKNOWN', city_clean)) ~> cleanCity",
				"selectColumns filter(store_name != 'Apple Park Visitor Center,Cupertino,United States,2017' && store_name != '12345' && city!= '2006') ~> filtrarBasura",
				"filtrarBasura aggregate(groupBy(store_id,",
				"          store_name,",
				"          city,",
				"          country,",
				"          opened_year),",
				"     row_cont = count()) ~> filtrarDuplicados",
				"filtrarDuplicados select(mapColumn(",
				"          store_id,",
				"          store_name,",
				"          city,",
				"          country,",
				"          opened_year",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> selectFinal",
				"selectFinal sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          store_id as string,",
				"          store_name as string,",
				"          city as string,",
				"          country as string,",
				"          opened_year as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> sink1"
			]
		}
	}
}